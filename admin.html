<!DOCTYPE html>
<html>
<head>
  <title>Admin Upload</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
<h2>Upload Image</h2>
<input type="file" id="fileInput"/>
<button onclick="uploadFiles()">Upload</button>

<h2>Uploaded Images</h2>
<div id="preview" style="display:flex; flex-wrap:wrap;"></div>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyC-z6TPCJ4WsE7sGdlXgrFJIM_3IJtOo7s",
    authDomain: "hardrock-media.firebaseapp.com",
    projectId: "hardrock-media",
    storageBucket: "hardrock-media.firebasestorage.app",
    messagingSenderId: "1039350595521",
    appId: "1:1039350595521:web:8ec84ad4d9204a36a8b940"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const CLOUD_NAME = "djoqjaxba";
  const UPLOAD_PRESET = "unsigned_upload";

  // Upload image to Cloudinary & store URL in Firestore
  async function uploadFiles() {
    const file = document.getElementById("fileInput").files[0];
    if(!file) return alert("Select a file");

    const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`;
    const formData = new FormData();
    formData.append("file", file);
    formData.append("upload_preset", UPLOAD_PRESET);

    try {
      const res = await fetch(url, { method:"POST", body:formData });
      const data = await res.json();

      await db.collection("images").add({
        url: data.secure_url,
        public_id: data.public_id,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });

      showUploadedImages();
    } catch(err) {
      console.error(err);
    }
  }

  // Display all images with delete button
  async function showUploadedImages() {
    const snapshot = await db.collection("images").orderBy("timestamp","desc").get();
    const previewDiv = document.getElementById("preview");

    previewDiv.innerHTML = snapshot.docs.map(doc => {
      const img = doc.data();
      return `
        <section class="gallery_img">
          <img src="${img.url}" width="200"/>
          <button onclick="deleteImage('${doc.id}','${img.public_id}')"
                  style="position:absolute; top:0; right:0; background:red; color:white; border:none; cursor:pointer;">
            âœ–
          </button>
        </section>`;
    }).join('');
  }

  // Delete image from Cloudinary & Firestore
  async function deleteImage(docId, publicId) {
    if(!confirm("Delete this image?")) return;

    // Delete from Firestore
    await db.collection("images").doc(docId).delete();

    // Optional: Delete from Cloudinary using backend
    // Frontend cannot securely delete from Cloudinary

    showUploadedImages();
  }

  showUploadedImages();
</script>
</body>
</html>
